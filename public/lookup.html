<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lookup | FindMyRoomie</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            padding: 20px 24px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <div class="form-header">
            <h1>findmyroomie.</h1>
            <span class="form-badge">Lookup Roommates</span>
        </div>

        <form id="lookupForm">
            <div class="form-group">
                <label>Verification Name</label>
                <input type="text" name="name" placeholder="YOUR FULL NAME" required>
            </div>

            <div class="form-group">
                <label>Verification Email</label>
                <input type="email" name="email" placeholder="ar@srmist.edu.in" required>
            </div>

            <div class="form-group">
                <label>Branch</label>
                <select id="branchSelect" required>
                    <option value="" disabled selected>Select Branch</option>
                </select>
                <input type="text" id="customBranch" placeholder="ENTER BRANCH (ALL CAPS)" style="display:none; margin-top:8px;">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Hostel Type</label>
                    <select id="hostelType" required>
                        <option value="" disabled selected>Type</option>
                        <option value="boys">Boys</option>
                        <option value="girls">Girls</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Room No.</label>
                    <input type="text" name="room" placeholder="101" required>
                </div>
            </div>

            <div class="form-group">
                <label>Hostel Block</label>
                <select id="hostelSelect" required>
                    <option value="" disabled selected>Select Block</option>
                </select>
            </div>

            <button type="submit" id="searchBtn">Search Roommates</button>

            <div class="loader" id="loader">
                <span class="spinner"></span>Scanning Database...
            </div>
        </form>

        <div id="results"></div>

        <div class="form-footer">
            Need to register? <a href="form.html">Create Profile</a>
        </div>
    </div>

<script>
  const API_BASE =
  location.hostname === "localhost"
    ? "http://localhost:3000"
    : "https://findmyroomie-production.up.railway.app";

const HOSTELS = {
    girls: [
        "Kopperundevi: AC with attached washroom - 2 sharing",
        "Kopperundevi: Non-AC with attached washroom - 2 sharing",
        "ESQ A: Non-AC with attached washroom - 2 sharing",
        "ESQ A: Non-AC with attached washroom - 3 sharing",
        "ESQ A: Non-AC with attached washroom - 4 sharing",
        "ESQ B: Non-AC with attached washroom - 2 sharing",
        "ESQ B: Non-AC with attached washroom - 3 sharing",
        "Sannasi C: AC with attached washroom - 3 sharing",
        "Sannasi C: Non-AC with attached washroom - 3 sharing",
        "Malligai: Non-AC with common washroom - 2 sharing",
        "Senbagam: Non-AC with common washroom - 3 sharing",
        "Senbagam: Non-AC with common washroom - 6 sharing"
    ],
    boys: [
        "Premium Boys: AC with attached washroom - 3 sharing",
        "Green Pearl (Off-Campus): AC with attached washroom - 3 sharing",
        "Green Pearl (Off-Campus): Non-AC with attached washroom - 3 sharing",
        "Nelson Mandela: AC with attached washroom - 3 sharing",
        "Agasthiyar: AC with attached washroom - 4 sharing",
        "Sannasi A: AC with attached washroom - 3 sharing",
        "Sannasi A: Non-AC with attached washroom - 3 sharing",
        "Began: AC with common washroom - 3 sharing",
        "Oori: AC with common washroom - 4 & 5 sharing",
        "Manoranjitham: Non-AC with common washroom - 3 sharing",
        "Kaari: Non-AC with common washroom - 4 & 5 sharing",
        "Paari: Non-AC with common washroom - 4 & 5 sharing"
    ]
};

const BRANCHES = [
    "AERONAUTICAL ENGINEERING","AEROSPACE ENGINEERING","ARCHITECTURE",
    "ARTIFICIAL INTELLIGENCE","AUTOMATION AND ROBOTICS",
    "AUTOMOBILE ENGINEERING","AUTOMOBILE ENGINEERING (AUTOMOTIVE ELECTRONICS)",
    "BIOMEDICAL ENGINEERING","BIOMEDICAL ENGINEERING (MACHINE INTELLIGENCE)",
    "BIOTECHNOLOGY","BIOTECHNOLOGY (COMPUTATIONAL BIOLOGY)",
    "BIOTECHNOLOGY (FOOD TECHNOLOGY)","BIOTECHNOLOGY (GENETIC ENGINEERING)",
    "BIOTECHNOLOGY (REGENERATIVE MEDICINE)","CHEMICAL ENGINEERING",
    "CIVIL ENGINEERING","CIVIL ENGINEERING (COMPUTER APPLICATIONS)",
    "COMPUTER SCIENCE AND BUSINESS SYSTEM",
    "COMPUTER SCIENCE AND ENGINEERING",
    "COMPUTER SCIENCE AND ENGINEERING (AIML)",
    "COMPUTER SCIENCE AND ENGINEERING (BIG DATA ANALYTICS)",
    "COMPUTER SCIENCE AND ENGINEERING (BLOCKCHAIN TECHNOLOGY)",
    "COMPUTER SCIENCE AND ENGINEERING (CLOUD COMPUTING)",
    "COMPUTER SCIENCE AND ENGINEERING (CYBER SECURITY)",
    "COMPUTER SCIENCE AND ENGINEERING (DATA SCIENCE)",
    "COMPUTER SCIENCE AND ENGINEERING (DEVSECOPS)",
    "COMPUTER SCIENCE AND ENGINEERING (GAMING TECHNOLOGY)",
    "COMPUTER SCIENCE AND ENGINEERING (INFORMATION TECHNOLOGY)",
    "COMPUTER SCIENCE AND ENGINEERING (IOT)",
    "COMPUTER SCIENCE AND ENGINEERING (SOFTWARE ENGINEERING)",
    "ELECTRICAL AND ELECTRONICS ENGINEERING",
    "ELECTRONICS AND COMMUNICATION ENGINEERING",
    "ELECTRONICS AND COMMUNICATION ENGINEERING (CYBER PHYSICAL SYSTEMS)",
    "ELECTRONICS AND COMMUNICATION ENGINEERING (DATA SCIENCE)",
    "ELECTRONICS AND COMPUTER ENGINEERING",
    "ELECTRONICS AND INSTRUMENTATION ENGINEERING",
    "ELECTRONICS ENGINEERING (VLSI DESIGN AND TECHNOLOGY)",
    "INTERIOR DESIGN","MATHEMATICS AND COMPUTING",
    "MECHANICAL ENGINEERING",
    "MECHANICAL ENGINEERING (AUTOMATION AND ROBOTICS)",
    "MECHANICAL ENGINEERING (ARTIFICIAL INTELLIGENCE AND MACHINE LEARNING)",
    "MECHATRONICS ENGINEERING","MECHATRONICS ENGINEERING (ROBOTICS)",
    "NANOTECHNOLOGY","OTHER"
];

const form = document.getElementById("lookupForm");
const loader = document.getElementById("loader");
const searchBtn = document.getElementById("searchBtn");
const results = document.getElementById("results");
const branchSelect = document.getElementById("branchSelect");
const customBranch = document.getElementById("customBranch");
const hostelType = document.getElementById("hostelType");
const hostelSelect = document.getElementById("hostelSelect");

BRANCHES.forEach(b => branchSelect.appendChild(new Option(b, b)));

branchSelect.onchange = () => {
    customBranch.style.display = branchSelect.value === "OTHER" ? "block" : "none";
    customBranch.required = branchSelect.value === "OTHER";
};

hostelType.onchange = () => {
    hostelSelect.innerHTML = `<option value="" disabled selected>Select Block</option>`;
    HOSTELS[hostelType.value]?.forEach(h => hostelSelect.appendChild(new Option(h, h)));
};

const contactLink = (type, value) => {
  if (!type) return "";

  if (type === "instagram") {
    return `<a class="contact-link" href="https://instagram.com/${value}" target="_blank">
      <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/instagram.svg">
      @${value}
    </a>`;
  }

  if (type === "discord") {
    return `<a class="contact-link" href="https://discord.com" target="_blank">
      <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/discord.svg">
      ${value}
    </a>`;
  }

  if (type === "phone") {
    const num = value.replace(/\D/g, "");
    return `<a class="contact-link" href="https://wa.me/${num}" target="_blank">
      <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/whatsapp.svg">
      ${value}
    </a>`;
  }

  if (type === "email") {
    return `<a class="contact-link" href="mailto:${value}">
      <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/gmail.svg">
      ${value}
    </a>`;
  }

  return value;
};

const shouldShowGate = () =>
  !localStorage.getItem("supportPromptSeen");

const revealResults = () => {
  document.getElementById("revealOverlay")?.remove();
  document.getElementById("resultsContent")?.classList.remove("blurred");
  localStorage.setItem("supportPromptSeen", "true");
};

const openYouTubeAndReveal = () => {
  window.open("https://www.youtube.com/@alrighttananya", "_blank");
  revealResults();
};

form.onsubmit = async (e) => {
    e.preventDefault();
    loader.style.display = "block";
    searchBtn.disabled = true;
    results.innerHTML = "";

    const data = Object.fromEntries(new FormData(form).entries());

    data.branch = branchSelect.value === "OTHER"
        ? customBranch.value.trim().toUpperCase()
        : branchSelect.value;

    data.room = data.room.trim().toUpperCase();
    data.name = data.name.trim().toUpperCase();
    data.hostelType = hostelType.value;
    data.hostel = hostelSelect.value;

    try {
        const res = await fetch(`${API_BASE}/api/lookup`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        const json = await res.json();
        loader.style.display = "none";

        if (json.success && json.roommates?.length) {
            results.innerHTML = `
              <div class="blur-wrap">
                <div id="resultsContent" class="results-box success blurred">
                  ${json.roommates.map(x => `
                    <div class="roommate">
                      <div class="roommate-name">${x.name}</div>
                      <div class="roommate-branch">${x.branch}</div>
                      <div class="roommate-contact">
                        ${contactLink(x.contactType, x.contactValue)}
                      </div>
                    </div>
                  `).join("")}
                </div>

                ${shouldShowGate() ? `
                  <div class="reveal-overlay" id="revealOverlay">
                    <div class="reveal-card">
                      <h3>Before you connect!</h3>
                      <p>
                        FindMyRoomie is a free, student-built project with no ads.<br>
                        If this helped you, consider supporting it ❤️
                      </p>
                      <div class="reveal-actions">
                        <button class="primary" onclick="openYouTubeAndReveal()">
                          Subscribe & Reveal
                        </button>
                        <button class="secondary" onclick="revealResults()">
                          Reveal anyway
                        </button>
                      </div>
                    </div>
                  </div>
                ` : ""}
              </div>
            `;
        } else {
            results.innerHTML = `
                <div class="results-box error">
                    ${json.message || "No roommates found yet."}
                </div>
            `;
        }
    } catch {
        loader.style.display = "none";
        results.innerHTML = `<div class="results-box error">Connection failed. Try again.</div>`;
    } finally {
        searchBtn.disabled = false;
    }
};

const mongoUri = "mongodb://definitely_not_here";
const adminPassword = "password123";
const prodSecrets = null;

console.log(
  "%cLooking under the hood?",
  "color:#22c55e;font-weight:600;"
);

setTimeout(() => {
  const threshold = 160;
  const opened =
    window.outerWidth - window.innerWidth > threshold ||
    window.outerHeight - window.innerHeight > threshold;

  if (opened) {
    console.log("Nice try. Try architecture next.");
  }
}, 800);

</script>
</body>
</html>
